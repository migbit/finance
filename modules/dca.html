<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DCA</title>
  <link rel="stylesheet" href="../css/styles.pcolor.css">
  <link rel="stylesheet" href="../css/mobile.css">
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />
  <link rel="manifest" href="../manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>

<body data-page="dca">
  <!-- Hamburger icon (always visible on mobile) -->
  <button id="menu-icon" aria-label="Open menu">‚ò∞</button>
  
  <!-- Header / Nav -->
  <header>
    <nav id="nav-menu">
      <ul>
        <!-- Login/User section at top -->
        <li id="login-section" class="login-block">
          <a href="#" id="login-btn" class="login-visible">üîê Login</a>
          <span id="user-info" class="user-visible" style="display:none;">
            <a href="#" id="user-name">üë§ Username</a>
          </span>
        </li>

        <li class="separator"></li>

        <!-- Sec√ß√£o: Apartamentos -->
        <li class="menu-title">Apartamentos</li>
        <li><a href="faturas.html">üìÑ Faturas</a></li>
        <li><a href="analisev3.html">üìä An√°lise</a></li>
        <li><a href="analise123.html">üè† 123</a></li>
        <li><a href="analise1248.html">üè† 1248</a></li>
        <li><a href="analise123vs1248.html">‚öñÔ∏è 123 vs 1248</a></li>
        <li><a href="caixa.html">üí∞ Caixa</a></li>
        <li><a href="tmt.html">üß≥ Taxa Tur√≠stica</a></li>
        <li><a href="diversos.html">üìã Diversos</a></li>
        <li><a href="settings.html">üõü Backup</a></li>

        <li class="separator"></li>

        <!-- Sec√ß√£o: Investimentos -->
        <li class="menu-title">Investimentos</li>
        <li><a href="dca.html" class="active">üìà DCA</a></li>
        <li><a href="crypto.html">üöÄ Cripto</a></li>
      </ul>
    </nav>
  </header>

  <main class="dca-page">
    <!-- === T√≠tulo === -->
    <h2 class="page-title center">DCA ‚Äì Trade Republic</h2>
    <section class="report-section" id="dca-etf-quotes">
      <div class="viz-card etf-card">
        <div class="etf-card-header">
          <h4>Cota√ß√µes ETFs</h4>
          <div class="etf-card-meta">
            <span id="dca-etf-updated" aria-live="polite">Atualizado a ‚Äî</span>
            <button type="button" class="page-meta-reload" id="dca-etf-refresh" aria-label="Recarregar cota√ß√µes" title="Recarregar cota√ß√µes">‚Üª</button>
          </div>
        </div>
        <div id="dca-etf-error" class="form-feedback error" aria-live="polite"></div>
        <div class="etf-quote-grid">
          <article class="etf-quote-card" data-ticker="VWCE">
            <header>
              <span class="etf-ticker">VWCE</span>
              <span class="etf-name">Vanguard FTSE All-World UCITS</span>
            </header>
            <div class="etf-price" id="etf-vwce-price">-</div>
            <div class="etf-change" id="etf-vwce-change">-</div>
            <div class="etf-extra" id="etf-vwce-extra">‚Äî</div>
            <div class="etf-positions">
              <label class="etf-qty-field">
                <span>Quantidade</span>
                <input type="number" step="0.0001" min="0" id="etf-vwce-qty" placeholder="0.0000" />
              </label>
              <div class="etf-metrics">
                <div class="etf-metric">
                  <span>Valor Total</span>
                  <strong id="etf-vwce-total">-</strong>
                </div>
                <div class="etf-metric">
                  <span>Investido</span>
                  <strong id="etf-vwce-invested">-</strong>
                </div>
                <div class="etf-metric">
                  <span>Resultado</span>
                  <strong id="etf-vwce-result">-</strong>
                </div>
              </div>
            </div>
          </article>
          <article class="etf-quote-card" data-ticker="AGGH">
            <header>
              <span class="etf-ticker">AGGH</span>
              <span class="etf-name">iShares Core Global Aggregate Bond</span>
            </header>
            <div class="etf-price" id="etf-aggh-price">-</div>
            <div class="etf-change" id="etf-aggh-change">-</div>
            <div class="etf-extra" id="etf-aggh-extra">‚Äî</div>
            <div class="etf-positions">
              <label class="etf-qty-field">
                <span>Quantidade</span>
                <input type="number" step="0.0001" min="0" id="etf-aggh-qty" placeholder="0.0000" />
              </label>
              <div class="etf-metrics">
                <div class="etf-metric">
                  <span>Valor Total</span>
                  <strong id="etf-aggh-total">-</strong>
                </div>
                <div class="etf-metric">
                  <span>Investido</span>
                  <strong id="etf-aggh-invested">-</strong>
                </div>
                <div class="etf-metric">
                  <span>Resultado</span>
                  <strong id="etf-aggh-result">-</strong>
                </div>
              </div>
            </div>
          </article>
        </div>
      </div>
    </section>

    <!-- === Par√¢metros & Juro (collapsible) === -->
    <section class="report-section">
      <div style="text-align: center; margin-bottom: 1rem;">
        <button id="btn-toggle-params" type="button" class="primary">Mostrar Par√¢metros</button>
      </div>
      
      <div id="params-juro-container" style="display: none;">
        <!-- Par√¢metros -->
        <div class="viz-card params-card">
          <h4>Par√¢metros</h4>
          <div class="table-wrap">
            <table class="table-dca params-table" id="params-table">
              <thead>
                <tr>
                  <th class="num">Data final</th>
                  <th class="num">VWCE %</th>
                  <th class="num">AGGH %</th>
                  <th class="num">Contribui√ß√£o Mensal</th>
                  <th style="width:140px">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="num"><input id="end-date" type="month" /></td>
                  <td class="num"><input id="pct-swda" type="number" min="0" max="100" step="0.01" /></td>
                  <td class="num"><input id="pct-aggh" type="number" min="0" max="100" step="0.01" /></td>
                  <td class="num">
                    <div class="input-euro">
                      <input id="monthly-contribution" type="number" step="1" value="152" />
                    </div>
                  </td>
                  <td style="text-align:right">
                    <button id="btn-save-params" type="button" class="primary" aria-label="Gravar par√¢metros">‚úì</button>
                  </td>
                </tr>
                <tr class="scenario-rate-row">
                  <td colspan="5">
                    <div class="scenario-rate-inputs" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; justify-content: flex-start;">
                      <span class="scenario-rate-label">Taxa dos Cen√°rios:</span>
                      <label style="display:flex; align-items:center; gap:0.4rem;">
                        Conservador (%)
                        <input id="scenario-rate-conservative" type="number" step="0.1" min="-50" max="50" style="width:90px;" />
                      </label>
                      <label style="display:flex; align-items:center; gap:0.4rem;">
                        Moderado (%)
                        <input id="scenario-rate-moderate" type="number" step="0.1" min="-50" max="50" style="width:90px;" />
                      </label>
                      <label style="display:flex; align-items:center; gap:0.4rem;">
                        Otimista (%)
                        <input id="scenario-rate-optimistic" type="number" step="0.1" min="-50" max="50" style="width:90px;" />
                      </label>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
            <div id="params-feedback" class="form-feedback" aria-live="polite"></div>
          </div>
        </div>

        <!-- Juro -->
        <div class="viz-card juro-card">
          <h4>Juro</h4>
          <div class="table-wrap">
            <table class="table-dca" id="juro-table">
              <thead>
                <tr>
                  <th class="num">Saldo</th>
                  <th class="num">Taxa de juro</th>
                  <th class="num">Valor mensal</th>
                  <th class="num">Valor ganho em Juros</th>
                  <th style="text-align:center">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="num">
                    <div class="input-euro">
                      <input id="juro-saldo" type="number" step="0.01" class="cell" placeholder="0,00" inputmode="decimal" />
                    </div>
                  </td>
                  <td class="num">
                    <input id="juro-taxa" type="number" step="0.01" class="cell" value="2.00" disabled />
                  </td>
                  <td class="num"><span id="juro-mensal">0 ‚Ç¨</span></td>
                  <td class="num"><span id="juro-acumulado">0 ‚Ç¨</span></td>
                  <td style="text-align:center">
                    <button id="btn-juro-gravar" type="button" class="primary" aria-label="Gravar juro">‚úì</button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div id="juro-feedback" class="form-feedback" aria-live="polite"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- === KPIs & Cen√°rios === -->
    <section class="report-section">
      <div class="viz-card" id="kpi-cenarios-card">
        <h4 style="margin-bottom: 1rem;">KPIs & Cen√°rios</h4>
        
        <!-- Current Performance KPIs -->
        <div class="kpi-grid enhanced">
          <div class="kpi-item enhanced">
            <div class="kpi-label">Total Investido</div>
            <div class="kpi-value" id="kpi-total-invested">-</div>
          </div>
          <div class="kpi-item enhanced">
            <div class="kpi-label">Valor Atual</div>
            <div class="kpi-value" id="kpi-current-value">-</div>
          </div>
          <div class="kpi-item enhanced">
            <div class="kpi-label">Resultado</div>
            <div class="kpi-value">
              <span id="kpi-result">-</span>
              <span class="kpi-sub" id="kpi-result-pct" style="font-size: 0.75rem; margin-left: 0.25rem;">-</span>
            </div>
          </div>
          <div class="kpi-item enhanced">
            <div class="kpi-label">Juros Acum.</div>
            <div class="kpi-value" id="kpi-total-interest">-</div>
          </div>
        </div>

        <!-- Investment Progress Bar -->
        <div class="progress-section" style="margin-top: 1.5rem;">
          <div class="progress-header" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="font-weight: 600; color: var(--text-dim);">Progresso do Investimento</span>
            <span style="font-weight: 700; color: var(--p2);" id="progress-percentage">0%</span>
          </div>
          <div class="progress-bar-container" style="height: 32px; background: #e5e7eb; border-radius: 16px; overflow: hidden; position: relative;">
            <div class="progress-bar-fill" id="progress-bar-fill" style="height: 100%; background: linear-gradient(90deg, #1a8f5d 0%, #16a34a 100%); width: 0%; transition: width 0.6s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 12px;">
              <span style="color: white; font-weight: 700; font-size: 0.85rem;" id="progress-bar-text"></span>
            </div>
          </div>
          <div class="progress-footer" style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-dim);">
            <span id="progress-invested">0 ‚Ç¨</span>
            <span id="progress-target">0 ‚Ç¨</span>
          </div>
        </div>

        <!-- Scenario Comparison -->
        <div class="scenario-comparison" style="margin-top: 1.5rem;">
          <h5 style="text-align: center; margin-bottom: 1rem; color: var(--text-dim);">Cen√°rios de Crescimento</h5>
          <div class="scenario-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div class="scenario-card" data-scenario="conservative">
              <div class="scenario-header" style="background: #e8f5e8; padding: 0.75rem; border-radius: 8px 8px 0 0;">
                <div class="scenario-title" style="font-weight: 700; color: #2e7d32;">Conservador</div>
                <div class="scenario-rate" id="scenario-conservative-rate" style="font-size: 0.9rem; color: #2e7d32;">+0%</div>
              </div>
              <div class="scenario-body" style="padding: 0.75rem; background: white; border-radius: 0 0 8px 8px;">
                <div class="scenario-line" style="display: flex; align-items: baseline; gap: 0.35rem; justify-content: center;">
                  <span class="scenario-value" id="scenario-conservative">-</span>
                  <span class="scenario-diff" style="font-size: 0.85rem; font-weight: 600;" id="scenario-conservative-diff">-</span>
                </div>
              </div>
            </div>
            <div class="scenario-card" data-scenario="moderate">
              <div class="scenario-header" style="background: #e3f2fd; padding: 0.75rem; border-radius: 8px 8px 0 0;">
                <div class="scenario-title" style="font-weight: 700; color: #1565c0;">Moderado</div>
                <div class="scenario-rate" id="scenario-moderate-rate" style="font-size: 0.9rem; color: #1565c0;">+0%</div>
              </div>
              <div class="scenario-body" style="padding: 0.75rem; background: white; border-radius: 0 0 8px 8px;">
                <div class="scenario-line" style="display: flex; align-items: baseline; gap: 0.35rem; justify-content: center;">
                  <span class="scenario-value" id="scenario-moderate">-</span>
                  <span class="scenario-diff" style="font-size: 0.85rem; font-weight: 600;" id="scenario-moderate-diff">-</span>
                </div>
              </div>
            </div>
            <div class="scenario-card" data-scenario="optimistic">
              <div class="scenario-header" style="background: #fff3e0; padding: 0.75rem; border-radius: 8px 8px 0 0;">
                <div class="scenario-title" style="font-weight: 700; color: #ef6c00;">Otimista</div>
                <div class="scenario-rate" id="scenario-optimistic-rate" style="font-size: 0.9rem; color: #ef6c00;">+0%</div>
              </div>
              <div class="scenario-body" style="padding: 0.75rem; background: white; border-radius: 0 0 8px 8px;">
                <div class="scenario-line" style="display: flex; align-items: baseline; gap: 0.35rem; justify-content: center;">
                  <span class="scenario-value" id="scenario-optimistic">-</span>
                  <span class="scenario-diff" style="font-size: 0.85rem; font-weight: 600;" id="scenario-optimistic-diff">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- === Charts Section === -->
    <section class="report-section">
      <div class="viz-card">
        <h4>Gr√°ficos de Desempenho</h4>
        <div class="chart-controls" style="margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center;">
          <label for="chart-type" class="sr-only">Tipo de gr√°fico</label>
          <select id="chart-type">
            <option value="portfolio-growth">Crescimento do Portef√≥lio</option>
            <option value="contributions-vs-growth">Contribui√ß√µes vs Crescimento</option>
            <option value="asset-allocation">Distribui√ß√£o de Ativos</option>
            <option value="returns-comparison">Compara√ß√£o de Retornos</option>
          </select>
          <button id="export-chart">Exportar gr√°fico</button>
          <div class="chart-range-control" style="display:flex; align-items:center; gap:0.5rem;">
            <label for="chart-range-end">At√©:</label>
            <input type="range" id="chart-range-end" min="1" value="1" style="width:160px;">
            <span id="chart-range-label" style="font-weight:600;">-</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="performance-chart"></canvas>
        </div>
      </div>
    </section>

    <!-- === Performance Metrics === -->
    <section class="report-section">
      <div class="viz-card">
        <h4>M√©tricas Avan√ßadas de Desempenho</h4>
        <div class="metrics-grid">
          <div class="metric-item">
            <div class="metric-label">Rendimento Ponderado pelo Tempo</div>
            <div class="metric-value" id="twr-value">-</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Rendimento Ponderado pelo Dinheiro</div>
            <div class="metric-value" id="mwr-value">-</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Rendimento Anualizado</div>
            <div class="metric-value" id="annualized-return">-</div>
          </div>
        </div>
      </div>
    </section>

    <!-- === Registo Mensal === -->
    <section class="report-section">
      <div class="viz-card">
        <h4>Registo Mensal</h4>
        <div class="table-wrap" id="dca-table-wrap"><!-- tabela via JS --></div>
        <div class="center" style="margin-top: 1rem; display:flex; gap:0.75rem; justify-content:center;">
          <button id="toggle-others" type="button">Expandir anos</button>
          <button id="export-csv-inline" type="button" class="primary">Exportar CSV</button>
        </div>
      </div>
    </section>

    <!-- === Portfolio Rebalancing === -->
    <section class="report-section">
      <div class="viz-card">
        <h4>Rebalanceamento do Portef√≥lio</h4>
        <div id="rebalancing-status">
          <p>A analisar a aloca√ß√£o atual...</p>
        </div>
        <div id="rebalancing-suggestions" style="display: none;">
          <table class="table-dca">
            <thead>
              <tr>
                <th>Ativo</th>
                <th>% Atual</th>
                <th>% Alvo</th>
                <th>Diferen√ßa</th>
                <th>A√ß√£o</th>
              </tr>
            </thead>
            <tbody id="rebalancing-table">
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script type="module" src="../js/dca-main.js"></script>
</body>
</html>
